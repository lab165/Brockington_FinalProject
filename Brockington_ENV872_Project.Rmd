---
title: "Exploration of Bat Activity Along the Colorado River in Grand Canyon, AZ"
author: "Laura Brockington"
subtitle: https://github.com/lab165/Brockington_FinalProject
output:
  html_document:
    toc: yes
    theme: sandstone
---

\newpage
\tableofcontents

\listoftables

\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()

# Load your packages
library(tidyverse); library(lubridate); library(here); library(zoo)
library(trend); library(sf); library(leaflet); 
library(mapview); mapviewOptions(fgb = FALSE); library(dataRetrieval); library(ggspatial); library(rgdal); library(RColorBrewer); library(sp); library(knitr); library(GGally)

# Set your ggplot theme
mytheme <- theme_linedraw(base_size = 11) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "bottom")
theme_set(mytheme)

mapviewOptions(basemaps = c("Esri.WorldShadedRelief", "OpenStreetMap.DE"))

# Load your datasets
# Loading bat activity and insect abundance data
bat_data_raw <- read.csv(here("Data/Raw/Bat_Activity_Insect_Abundance_Data.csv"), 
                     stringsAsFactors = TRUE)
# Loading discharge data
siteNumber <- "09402500"
COriverInfo <- readNWISsite(siteNumber)
rawDailyData_COriver_discharge <- readNWISdv(
  siteNumber, "00060", statCd = "00003",
  "2017-04-29", "2020-10-22")
# Loading in CO River Shapefile for map
CO_river_utm <- st_read('./Data/Raw/az_hydro_routesNAD83/az_hydro_routesNAD83.shp') %>% filter(NAME == "Colorado River")
```

# Rationale and Research Questions

Bats provide irreplaceable ecosystem services. They play an essential role in pest control, pollination, and seed dispersal. However, population numbers have been decreasing globally due mostly to habitat loss and a highly contagious fungal borne illness known as white-nose syndrome. It is estimated that the continued decline of bat populations across North America will result in agricultural losses of more than \$3.7 billion/year (Boyles et al., 2011).

The data used in this study were originally compiled to better understand bat foraging behavior along the Colorado River in Grand Canyon, Arizona. This project aims to explore the relationship between bat activity, prey availability, temperature, vegetation cover, location, and river discharge with the following research questions:

1.  What factors influence bat activity (temperature, prey availability, vegetation cover, discharge) along the Colorado River in the Grand Canyon?
2.  How did discharge in the Colorado River change during the course of the bat study (2017-2021)?

I hypothesize that increased temperature and prey availability will significantly increase bat activity along the Colorado River in the Grand Canyon. I also hypothesize that discharge in the Colorado River significantly decreased from 2017 to 2021. The results of this study will help us better understand bats natural history traits in the southwestern US, including what factors most influence bat activity.

\newpage

# Dataset Information

The bat activity and insect abundance data in this study were collected by citizen scientists led by the US Geological Survey (USGS) in Grand Canyon, AZ. They recorded bat activity using handheld acoustic recorders and sampled insect abundance using light traps. Recording was done for one hour at dusk at 410 sampling locations (along a 470 km segment of the river) for 611 nights from April to October in 2017 to 2020. In total, 1,438 paired samples of bat activity and insect abundance were collected. Other environmental variables were recorded, including temperature, moon phase, and type of insect (aquatic or terrestrial) (Metcalfe et al., 2023). Details of the dataset's structure can be seen in Table 1. More information on this dataset can be found at: <https://www.usgs.gov/data/bat-activity-and-insect-abundance-data-along-colorado-river-grand-canyon-az>

| Variable         | Description                                                      |
|:-----------------|:-----------------------------------------------------------------|
| Date             | Date of survey                                                   |
| Daily Temp       | Average temperature (°C) on date of survey                       |
| Tall Veg         | Tall vegetation cover as a proportion of the total riparian area |
| Total Calls      | Total number of recorded bat calls                               |
| Total Prey Rate  | Total number of insects collected over the duration of sampling  |

: Table 1: Summary of bat activity dataset structure

The discharge data for the Colorado River was collected from the USGS National Water Information System. I used the daily mean discharge for each day that bats were surveyed in the primary dataset of bat activity (USGS, 2023). The shapefile of the Colorado River, which was only used for mapping the study area, was collected from the University of Arizona (Westfall, 2008).

The datasets were wrangled to only include variables of interest for this study. I first checked the class of each variable and adjusted the date and site columns to be dates and factors, respectively. I then created a new dataset, only including the variables of interest. I combined this dataset with the discharge data through an inner join so only rows with data from both were included. This left us with 1,428 rows of 8 variables. I also calculated the monthly average for each variable and subsetted this to a new dataframe.

\newpage

# Exploratory Analysis

To explore the data involved in this study, I first created a map of the study area (Figure 1). This is helpful in understanding the spatial extent of the data. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align="left", fig.width=8, fig.cap="Figure 1: Map of study area, Grand Canyon, AZ"}
bat_data_spatial <-
  bat_data_raw %>%
  st_as_sf(coords = c('Longitude','Latitude'),
           crs=4326) %>%
  select(Date, DailyTemp, Site, TotalCalls, TotalPreyRate, geometry)
COriver_discharge_site <-
  COriverInfo %>%
  st_as_sf(coords = c('dec_long_va','dec_lat_va'),
           crs=4269)
CO_river_utm <- st_zm(CO_river_utm)
bat_data_sf_utm <- st_transform(bat_data_spatial, 26912)
CO_river_discharge_utm <- st_transform(COriver_discharge_site, 26912)
overview_map <- mapView(CO_river_utm, 
        color = "royalblue3",
        map.types = "OpenStreetMap.DE",
        layer.name = "Colorado River") +
  mapView(bat_data_sf_utm, 
          zcol = "TotalCalls", 
          cex = 5, 
          lwd = 0.3,
          alpha = 0.8,
          col.regions = brewer.pal(10, "Purples"),
          map.types = "OpenStreetMap.DE",
          layer.name = "Bat Survey Sites (Total Calls)") +
  mapView(CO_river_discharge_utm,
          col.regions = "gold",
          map.types = "OpenStreetMap.DE",
          layer.name = "Discharge Site")
overview_map@map %>% setView(-112.0777, 36.2, zoom = 7.5)
```

The dimensions, column names, class, and head of each column for my combined (bat activity & discharge) dataset can be seen below.

```{r, include=FALSE}
bat_data_raw$Date <- mdy(bat_data_raw$Date)
bat_data_raw$Site<-as.factor(bat_data_raw$Site)
bat_data_processed <-
  bat_data_raw %>%
  select(Date, DailyTemp, TallVegByMSU, TotalCalls, TotalPreyRate) %>%
  rename(TallVeg = TallVegByMSU)
daily_discharge_processed <- rawDailyData_COriver_discharge %>%
  select(Date, X_00060_00003) %>%
  rename(discharge = X_00060_00003)
daily_bat_discharge <- inner_join(bat_data_processed, daily_discharge_processed)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
str(daily_bat_discharge)
```

I created a pairs plot of all of the continuous variables of interest in the study to visualize any relationships in my data that can be used to orient future analyses (Figure 2). It appears that no variables have particularly strong correlations, with all correlation coefficients under 0.3.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align="left", fig.cap="Figure 2: Pairs plots for all continuous variables of interest"}
ggpairs(data=daily_bat_discharge)
```

I plotted the discharge of the Colorado River across the timespan of the bat study, from 2017 through 2020. The high peak in November of 2018 was a controlled flood of the river.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align="left", fig.cap="Figure 3: Colorado river discharge over the course of the bat study (2017-2020)"}
discharge_plot <- #plotting discharge over time
ggplot(daily_discharge_processed, aes(x = Date, y = discharge)) +
  geom_point(size=1, alpha=0.7, color="steelblue4") +
  geom_line(lwd=0.1, color = "steelblue2") +
  geom_smooth(method = "lm", color = "palevioletred4") +
  ylab("Discharge (ft³/sec)") +
  xlab("Year") +
  scale_x_date(breaks = "years", date_labels = "%Y")
print(discharge_plot)
```

I created a new dataset with the monthly means of each of my variables (temperature, total bat calls, total prey rate, vegetation cover, and discharge) to more easily view trends across the survey timeline. As an example, figure 4 shows that the number of bat calls and river discharge changed over the course of the study. It appears that these two variables might have an inverse relationship, when discharge increases, the number of bat calls recorded decreases.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align="left", fig.cap="Figure 4: Mean monthly calls and mean monthly discharge across study timeline"}
bat_data_monthly_calls <-
  bat_data_raw %>%
  separate(Date, c("Year","Month", "Null")) %>% 
  mutate(Date = my(paste0(Month,"-",Year))) %>%
  group_by(Year, Month) %>%
  summarize(mean_calls = mean(TotalCalls)) %>%
  select(Year, Month, mean_calls)
bat_data_monthly_prey <-
  bat_data_raw %>%
  separate(Date, c("Year","Month", "Null")) %>% 
  mutate(Date = my(paste0(Month,"-",Year))) %>%
  group_by(Year, Month) %>%
  summarize(mean_prey = mean(TotalPreyRate)) %>%
  select(Year, Month, mean_prey)
bat_data_monthly_temp <-
  bat_data_raw %>%
  separate(Date, c("Year","Month", "Null")) %>% 
  mutate(Date = my(paste0(Month,"-",Year))) %>%
  group_by(Year, Month) %>%
  summarize(mean_temp = mean(DailyTemp)) %>%
  select(Year, Month, mean_temp)
bat_data_monthly_veg <-
  bat_data_raw %>%
  separate(Date, c("Year","Month", "Null")) %>% 
  mutate(Date = my(paste0(Month,"-",Year))) %>%
  group_by(Year, Month) %>%
  summarize(mean_veg = mean(TallVegByMSU)) %>%
  select(Year, Month, mean_veg)
bat_data1 <- inner_join(bat_data_monthly_calls, bat_data_monthly_prey)
bat_data2 <- inner_join(bat_data1, bat_data_monthly_temp)
bat_data_monthly <- inner_join(bat_data2, bat_data_monthly_veg)
bat_data_monthly <- #adding year-month-day column for each month
  bat_data_monthly %>%
  mutate(Date = make_date(year = Year, month = Month, day = 01))
monthly_discharge <- #wrangling data to have monthly averages
  daily_discharge_processed %>% 
  separate(Date, c("Year","Month", "Null")) %>% 
  mutate(Date = my(paste0(Month,"-",Year))) %>%
  group_by(Year, Month) %>%
  summarize(mean_discharge = mean(discharge)) %>%
  select(Year, Month, mean_discharge)
monthly_discharge <- #adding year-month-day column for each month
  monthly_discharge %>%
  mutate(Date = make_date(year = Year, month = Month, day = 01)) %>%
  select(Date, Year, Month, mean_discharge)
monthly_bat_discharge <- inner_join(bat_data_monthly, monthly_discharge)
coeff <- 100
bat_discharge_plot3 <-
ggplot(monthly_bat_discharge, aes(x = Date)) +
  geom_point(aes(y = mean_calls, color = "palevioletred4")) +
  geom_line(aes(y = mean_discharge/coeff, color = "steelblue4")) +
  xlab("Date") +
  scale_x_date(breaks = "2 months") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(name = "Mean # of Bat Calls", sec.axis = sec_axis(trans=~.*100, name=("Mean Discharge (ft³/sec)"))) +
  scale_color_discrete(name = "Legend", labels = c("Bat Calls", "Discharge"))
print(bat_discharge_plot3)
```

Summary statistics for each of the variables of interest (Table 2) helps us to better understand the data.

| Variable         | Mean   | Median | SD      | Min   | Max      |
|:-----------------|:-------|:-------|:--------|:------|:---------|
| Daily Temp       | 27.29  | 27.50  | 5.26    | 12.50 | 41.67    |
| Tall Veg         | 0.69   | 0.44   | 0.66    | 0.00  | 3.55     |
| Total Calls      | 146.80 | 151.00 | 68.80   | 1.00  | 469.00   |
| Total Prey Rate  | 657.90 | 303.20 | 1147.07 | 0.00  | 18873.00 |

: Table 2: Summary statistics for variables of interest

\newpage

# Analysis

### Question 1: What factors influence bat activity (temperature, prey availability, vegetation cover, discharge) along the Colorado River in the Grand Canyon?

H₀: There is no significant relationship between number of bat calls and temperature, prey availability, vegetation cover, or discharge.

Hₐ: There is a significant relationship between number of bat calls and temperature, prey availability, vegetation cover, or discharge.

A multiple linear regression was used to determine which factors significantly influence the number of recorded bat calls. First, a stepwise regression found which factors should be included in the full linear model. It was found that daily temperature, tall vegetation cover, and discharge should be included in the linear model.

```{r, echo=F, warning=F, message=F}
lm <- lm(data = daily_bat_discharge, TotalCalls ~ DailyTemp + TallVeg + discharge)
summary(lm)
```

The model is significant (p < 0.001) with an R² value of 0.038, meaning this model only explains about 3.8% of the variability in the number of bat calls.

All three variables (daily temperature, tall vegetation cover, and discharge) were found to be significant (p < 0.001) predictors of the number of bat calls. We therefore reject the null hypothesis and accept the alternative hypothesis that daily temperature, tall vegetation cover, and discharge predict the number of bat calls. The coefficients of the variables show that with an increase of 1.26 °C in daily temperature, the number of bat calls increases by 1. An increase of 15.0 in the ratio of tall vegetation cover results in an increase of the number of bat calls by 1. A decrease of 0.004 in river discharge results in an increase of the number of bat calls by 1.

### Question 2: How did discharge in the Colorado River change during the course of the bat study (2017-2021)?

H₀: There is no significant change in discharge.

Hₐ: There is a significant change in discharge.

A time series object of the Colorado River discharge was created to understand changes over time during the time span of the bat activity study (2017-2020). I then decomposed the time series object to analyze the trend, seasonality, and remainder of the data (Figure 5).

```{r, echo=F, warning=F, message=F, fig.cap="Figure 5: Decomposed components of the Colorado River discharge time series"}
f_month <- month(first(daily_discharge_processed$Date))
f_year <- year(first(daily_discharge_processed$Date))
f_day <- day(first(daily_discharge_processed$Date))

daily_discharge_ts <- ts(daily_discharge_processed$discharge, 
                             start = c(f_year, f_month, f_day), 
                             frequency = 365) #creating daily time series object

daily_discharge_decomposed <- stl(daily_discharge_ts, s.window = "periodic")
#decomposing the daily time series

plot(daily_discharge_decomposed) #plotting the components
```

The decomposed time series object tells us that there is a seasonal component to this dataset. Therefore, the seasonal Mann-Kendall trend test was run to analyze the trend in the data.

```{r, echo=F, warning=F, message=F}
daily_discharge_trend <- trend::smk.test(daily_discharge_ts)
daily_discharge_trend
```

The seasonal Mann-Kendall test found a statistically significant trend in discharge of the Colorado River in Grand Canyon, AZ (p < 0.001). We therefore reject the null hypothesis and accept the alternative hypothesis that Colorado River discharge changed significantly from 2017 through 2020. The negative "S" value tells us that the significant trend in discharge was negative. 

I then removed the seasonality component of the time series object (Figure 6) and ran the Mann-Kendall test.

```{r, echo=F, warning=F, message=F, fig.cap = "Figure 6: Non-seasonal discharge for the Colorado River during the bat study (2017-2020)"}
daily_discharge_components <- 
  as.data.frame(daily_discharge_decomposed$time.series[,2:3])
daily_discharge_nonseasonal <- 
  mutate(daily_discharge_components,
         Non_seasonal = trend + remainder,
         Date = daily_discharge_processed$Date)
daily_discharge_nonseasonal_ts <- 
  ts(daily_discharge_nonseasonal$Non_seasonal, 
                               start = c(f_year, f_month, f_day), 
                               frequency = 365) #creating time series object
ns_discharge_plot <- #plotting discharge over time
ggplot(daily_discharge_nonseasonal, aes(x = Date, y = Non_seasonal)) +
  geom_point(size=1, alpha=0.7, color="steelblue4") +
  geom_line(lwd=0.1, color = "steelblue2") +
  ylab("Discharge (ft³/sec)") +
  xlab("Year") +
  geom_smooth(method = "lm", color = "palevioletred4", se = F) +
  scale_x_date(breaks = "years", date_labels = "%Y")
print(ns_discharge_plot)
```

```{r, echo=F, warning=F, message=F}
#running non-seasonal Mann-Kendall after removing seasonality
daily_discharge_nonseasonal_trend <-
  trend::mk.test(daily_discharge_nonseasonal_ts)
daily_discharge_nonseasonal_trend
```

The Mann-Kendall test still found a statistically significant negative trend in discharge of the Colorado River in Grand Canyon, AZ (p < 0.001, tau ~ -0.14). 

\newpage

# Summary and Conclusions

This study found that temperature, vegetation cover, and discharge predict the number of recorded bat calls (p < 0.001, n = 1428, R² = 0.038). Bat activity appears to increase with higher temperatures, more vegetation cover, and lower discharge. However, the low R² value indicates that the model does not explain much of the variability in the number of recorded bat calls. More explanatory variables would be necessary to better understand what causes changes in the number of bat calls recorded along the Colorado River in Grand Canyon, AZ.

These results only partially support my original hypothesis that an increase in temperature and prey availability will result in an increase in bat calls. Surprisingly, prey availability was not found to be a significant predictor of the number of recorded bat calls.

This study also found that Colorado River discharge in Grand Canyon significantly decreased over the course of the bat survey, from 2017 through 2020 (p < 0.001, S = -222). This supports my hypothesis that discharge in the Colorado River significantly decreased from 2017 to 2021. The Colorado River has been experiencing extreme drought conditions for many years, and the results from this time series analysis support that fact.

\newpage

# References

Boyles, J.G., Cryan, P.M., McCracken, G.F., & Kunz, T.H. (2011). Economic Importance of Bats in Agriculture. Science. Retrieved from <https://www.science.org/doi/10.1126/science.1201366>

Metcalfe, A., Kennedy, T., Fritzinger, C. (2023). Bat activity and insect abundance data along the Colorado River in Grand Canyon, AZ [dataset]. US Geologic Survey (USGS). Retrieved from <https://www.usgs.gov/data/bat-activity-and-insect-abundance-data-along-colorado-river-grand-canyon-az>

US Geologic Survey (USGS). (2023). Surface-Water Daily Data for the Nation [dataset]. Retrieved from <https://waterdata.usgs.gov/nwis/dv>

Westfall, E. (2008). Arizona Rivers Shapefiles [dataset]. The University of Arizona. Retrieved from <https://repository.arizona.edu/handle/10150/188710>
